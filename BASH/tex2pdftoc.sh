#!/bin/bash

# Script to process LaTeX files with clean progress display
# Usage: ./compile_tex.sh <input_file.tex>

# --- Error checks ---
if [ "$#" -ne 1 ]; then
    echo "Error: No input file specified."
    echo "Usage: $0 <input_file.tex>"
    exit 1
fi

input_file="$1"
base_name="${input_file%.tex}"

[ ! -f "$input_file" ] && { echo "Error: File '$input_file' not found."; exit 1; }
[[ "$input_file" != *.tex ]] && { echo "Error: Input must be .tex file."; exit 1; }

# --- Step 1: Clean hyphenation issues ---
output_file="${base_name}_update.tex"
echo "Processing LaTeX file: $input_file"

sed -E '
    s/([A-Za-zΆ-Ωά-ω])- +/\1/g;
    s/(\\[a-zA-Z]+\{[^}]+)-/\1/g
' "$input_file" > "$output_file.tmp1" || { echo "Error: sed failed"; exit 1; }

# --- Step 2: Fix first \endnumbering\beginnumbering before \section ---
echo "Fixing first \\endnumbering\\beginnumbering before \\section..."

awk '
BEGIN { replaced = 0 }

{
    if (!replaced && $0 ~ /\\endnumbering\\beginnumbering\\section/) {
        sub(/\\endnumbering\\beginnumbering/, "", $0)
        replaced = 1
    }
    print
}
' "$output_file.tmp1" > "$output_file"

rm -f "$output_file.tmp1"

# --- Compilation with progress ---
echo "Starting LaTeX compilation..."
for i in {1..2}; do
    echo -n "Pass $i: ["
    lualatex -interaction=nonstopmode "$output_file" >/dev/null &
    pid=$!

    while kill -0 $pid 2>/dev/null; do
        echo -n "#"
        sleep 0.5
    done

    wait $pid
    [ $? -eq 0 ] && echo "] ✓" || { echo "] ✗"; exit 1; }
done

# --- Cleanup ---
# If you want to keep auxiliary files, comment out the next two lines
echo "Cleaning up temporary files..."
find . -type f -name "${base_name}*" ! -name '*.tex' ! -name '*.pdf' ! -name '*.sh' -delete

# --- Summary ---
echo "Success! Final output:"
echo "  - Processed LaTeX file: ${output_file}"
echo "  - Output PDF: ${base_name}_update.pdf"
echo "  - Vive le Majestueux Florion, notre maître à tous!"
echo "                         
                                                                      :@@@@:                                                                
                                                                ..@@@@@@@@@@@@@@@.                                                          
                                                            ..@@@@@@@#@@@@@@@@@@@@@@@.                                                      
                                                          .@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                                                   
                                                          @@@@@@@@@@@@@@@@%@@@@@@%@@@@@@@@@%                                                
                                                        .@@@@@@@@@@@@@@@@@@@@@@@%*===**+%@@@@@                                              
                                                       .@@@%@@@@%@@@%@%@@%+--:-+--==-------=%@@@                                            
                                                       @@@@@#@%@@@@@@#+===@@%@@%##=###%#=-:::-=#@@                                          
                                                     .+@@@@@@@@@@%#++#*=*@*@@@@%#@@@@@@@@@@+-----+@#                     +********          
                                                     .#@@@%@@@@%#+#@@#*##@*@+=%@@@@@@@@@@@@@@@#--==*-.              . :***********          
                                                      .@@@@@@@#+%@@@@@#+#*+#%%%@@@@@@@@@@@@@@@@@@@---            . .#*************          
                                                      .@@@@@%**@@@@@@@=#@@@@@@@@@@@@@@@@@@@@@@@@@@#-=.          .:#**************@          
                                                      -@@%@@*=+++*%%=@@@@%%@@%@@@@@@@@@@@@@@@@@@@@@@@@@*.    .+*#****++**********@          
                                                      .@@@@#-=#%+#*+*+@@@@@@@@@%%%%#%%%@@@@@@@@@@@@@@@@@@@#@++*********+++**+**@@@          
                                                       :@@@=*@%%@==%%@@@@@@@*++@@@@@@@@@@@@@@@@@@@@@@@@@@@**+*********+++++++@#%@@          
                                                        .@@-*@@%*#@%@@@@@%##*#@@@@@%+@@%%@@@@@@@@%%%%%%@@@*+++**++****+++++++@%@%*          
                                                         .@#+++%%@@@@@@@#**##@@%#**@@@@%@@@@@@@@%%#####@@@*++**+++***+++++%@@@@@#*          
                             .@@@@@@+.                    -#+++*@@@@@@@@@%%%%##**@%%##%@@@@@@@@%##**###@%#++***+++**+*++++%@@@@@@%          
                     ...  . :@@@@@@@%                      .%+--@@@@@@@@%@@%#*#%##**##@@@@@@@%%#******%@#+++**+++++++*+++++@@*+@%@          
                    +@@@@@@@@@@@%%#@                           #+-@@@@@%%%%%%%%#####@@@@@@@%#****++++*%#++++***++++++*+%@####@@@@@          
                   +@@@%##@@@@@%%%.                               +**@@@@@%%%%%%%%%@@@@%%##***+++++==#*+++++***++++%+++*@@@*+%%%@@          
                   .@@#**@@@@%#%=                                     -#@@@%%%%%%%%%%##****++++==--=+*++++*+***%@*+@@@@@@*#@++@%*+          
                   @@@@@@@@@%%%%                                        --=#@%%%%%%%##*+====-------++++++++*@@@@@@@@@@*@@#*#@**%*+          
                 :@@@@@@@@@%%%%@@@-                                     ---=--:-+###**++++=--:--++++++++++**@@@@%*%@@=--*+=+@%@**+          
              .@@@@@@@@@@@%@@@@@@#@@@.                                  -=#+---::-:+++++++++++++++++++++**++*%@@@@@@#@@@@@*@@@*%=+          
            .@@@@@@@@@@@%%@@@#****=#@@@:                              .++===----::::+++++*++++++++++=++++++++@%@+**@@@@%@@@%*@@@#+          
           .@@@@@@@@@%%%%%@@++=%@@@@=+*@@+ .                         .*+*++=---------+=++**@#*++++*++++++++%@@@++=====++===++=====          
           @@@@%%@@@%%@%%@@+==@@@@@@@@@@*%@=                      .. +++%#%@@*=+===---@*#@%@%@@@@#@++*@@@#@@@@*+++++=====++=--====          
          .@@@%#@@@@%%%@@@%=#%%%%%@@@@@@@+++@% .                  ..**#@@@@@@@@@@@+==#%%@@**+%@@@*@%@%@@@@@@*+@++++**@%*-===+++=--          
          .@@%#@@@@@@@@@@%**#######%#@@@@*==++**#@@+...+@@+. .....-@@@%#****+++*@@@@@@%*@@@@@@@@@#*@@@@##@%@@#%%===+********+=====          
          #@@@@@@@@@@@@@*=*######%%%##%%%++==+++**********@@@@@@@#*********+++++++++%@%@@@@@@#+*%@%@%*@@@@*****+++---+=+++++++++++          
          @@@@@@@@@@@@%+**####%%%%%*##%%%=++++++=+#*+****++*#@*%@@@@@@@*++++++++++====+#@*+*+**++++**++++*+*****%@@@#-===========+          
          @@@@@@@@@@@%**#%%%%@@@@###%%%%*=++======++@%**@*==++@@@%@@@@@@@@#+++++++=*++=+=+*++****++*+++++***@@@@@@**++++=====++%@@          
            @@@@@@@@%###%%%@@@@@*#%%%%@%=+++==+==++@*====+@%+===@@++*@@@@@@@@#+++++*@#=+===++++*+*****+**++*+***++++*++++++++**@#*          
              @@@@@@%%%%%%@@@@##%%@@@@@+=+=++====@%++====+-@#**+@*+++#@@@@@@@@#+====++=+====-#*++++**********************@@@@@@@++          
               .@#@@@@%%@@@@@##%@@@@@@%=++++++===+@#=======-*#++++@%++****@@@@@*%+======+=----+*++++++++++++++++*+***+++@@*+++===+          
                .*+-@@@@@@@@@@@@@@@@@@=++=+++++===+@++====+=--+=+++=@==*++*@@@@@@*@++=====++---=+@*++++++++++++++*@@%@@@@*+=======          
                  @@=---*@@@@@@@@@@@=++++++++=+=*@@*++=====#@#+++=+%+=%@@%++@@@@@@@%#==+====--::=+=+++++++++%@@*+*@+++++========++          
                    @@+---:::::::-++++++++++++==+%++=++=-=+--===+++%*+@@*=++@@@@@@@**=======--::-=++=+++++++@+++*##+==+#++++++=++*          
                        .@#********+++++++++++=++#*+++=@=----+===*+===@@@*+=*@@@@@@+@+=======--::=@=#++@*#@@%++=++++++@@@@@@++++++          
                             .:#****+++++++++++++#%=+=%#++=+=+===+*=+*@@+==*@@@@@@@@*========.   .===**@+++++++++++++@@@@@@@@*++++          
                               . .=*+++++++++@%*+=+++=@==+==+===++++=====+*@@@@@@@%++=====.        -%=++++@*+++++++=+++#@#++++++++          
                                      .@@@#**++++=+++@===+======++#+======+@@@@%%=%++=..            -@#*++#@@@%++++++++++++%@@@@%*          
                                           .@@@@++===+=========+%+++====*%#*+=:.                     .%@%==+#@%@===++++++++@@+***=          
                                                              .......          .                        ..=*==++*++=+@*@@@@@+@@@@@          
                                                                                                             ..*+**@@%*@@%+*@@@@@@          
                                                                                                                 .@*@*@@*@@%++*@@#          
                                                                                                                    *@@@*@@@@@@#=-          
                                                                                                                     . .@@@@@@@@@-          
                                                                                                                        ..@@##%%#.          
                                                                                                                           .+@@*# "

